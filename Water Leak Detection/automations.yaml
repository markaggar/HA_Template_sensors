# Automations for Water Leak Detection v3 (Enhanced + Simplified Triggers)
# Rich notifications with direct sensor triggers (no binary sensor dependency)

- id: low_flow_leak_notify
  alias: Low Flow Leak Notification
  triggers:
  - value_template: "{% set min_val = states('sensor.low_flow_leak_min_5m') | float(0)
      %} \n{% set buf = state_attr('sensor.low_flow_leak_min_5m', 'age_coverage_ratio')
      | float(0) %} \n{{ min_val is number and buf is number and buf > 0.75 and min_val
      > 0 }}"
    trigger: template
  conditions:
  - condition: state
    entity_id: input_boolean.low_flow_leak_detected
    state: 'off'
    enabled: false
  actions:
  - entity_id: input_boolean.low_flow_leak_detected
    action: input_boolean.turn_on
  - data:
      message: 'Please check for small leaks or dripping faucets! Minimum low-flow
        water detected in last 5 mins has been  {{ states(''sensor.low_flow_leak_min_5m'')
        | round(3) }} GPM.  '
      title: Possible Persistent Low-Flow Leak
      data:
        tag: low_flow_leak_alert
        priority: high
        channel: Urgent
        actions:
        - action: ACKNOWLEDGE_LOW_FLOW_LEAK
          title: Acknowledge
    action: notify.all_family
  mode: single
- id: low_flow_leak_acknowledge_alert
  alias: 'Low Flow Leak: Acknowledge Alert'
  trigger:
  - platform: state
    entity_id: input_button.acknowledge_low_flow_leak
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: ACKNOWLEDGE_LOW_FLOW_LEAK
  action:
  - service: input_boolean.turn_off
    entity_id: input_boolean.low_flow_leak_detected
- id: low_flow_leak_clear
  alias: Low Flow Leak Cleared
  triggers:
  - value_template: "{% set min_val = states('sensor.low_flow_leak_min_5m') | float(0)
      %} \n{% set buf = state_attr('sensor.low_flow_leak_min_5m', 'age_coverage_ratio')
      | float(0) %} \n{{ min_val is number and buf is number and buf > 0 and min_val
      == 0 }}\n\n"
    trigger: template
  conditions:
  - condition: state
    entity_id: input_boolean.low_flow_leak_detected
    state: 'on'
    enabled: false
  actions:
  - entity_id: input_boolean.low_flow_leak_detected
    action: input_boolean.turn_off
  - data:
      message: Low-flow leak condition cleared. Water flow has returned to normal
        patterns.
      title: Low Flow Leak Cleared
      data:
        tag: low_flow_leak_alert
        priority: default
        channel: alarm
    action: notify.all_family
  mode: single
- id: leaky_toilet_smart_notify
  alias: Leaky Toilet Smart Notification
  triggers:
  - entity_id:
    - sensor.toilet_water_leak_detected
    to: 'True'
    trigger: state
    from: 'False'
  conditions:
  - condition: state
    entity_id: input_boolean.leaky_toilet_smart_detected
    state: 'off'
    enabled: false
  actions:
  - entity_id: input_boolean.leaky_toilet_smart_detected
    action: input_boolean.turn_on
  - data:
      message: "\U0001F6BD Detected {{ state_attr('sensor.toilet_water_leak_detected',
        'largest_group_count') }} repeating toilet fill patterns suggesting a leak!\n\U0001F4CA
        **Burst Analysis:** • Similar burst count: {{ state_attr('sensor.toilet_water_leak_detected',
        'largest_group_count') }} • Pattern window: {{ (state_attr('sensor.toilet_water_leak_detected',
        'burst_window') | int / 60) | round(0) }} minutes • Group threshold: {{ state_attr('sensor.toilet_water_leak_detected',
        'burst_group_threshold') }} gallons • Similar burst volumes: {{ state_attr('sensor.toilet_water_leak_detected',
        'largest_group_volumes') | join(', ') }} gallons\n\U0001F4C8 **Detection Parameters:**
        • Min group size: {{ state_attr('sensor.toilet_water_leak_detected', 'burst_min_group')
        }} • Flow range: {{ state_attr('sensor.toilet_water_leak_detected', 'burst_min_flow')
        }}-{{ state_attr('sensor.toilet_water_leak_detected', 'burst_max_flow') }}
        GPM • Duration range: {{ state_attr('sensor.toilet_water_leak_detected', 'burst_min_duration')
        }}-{{ state_attr('sensor.toilet_water_leak_detected', 'burst_max_duration')
        }} seconds\n\U0001F4A1 This may indicate a leaky toilet valve, flapper, or
        fill mechanism."
      title: Leaky Toilet Detected ({{ state_attr('sensor.toilet_water_leak_detected',
        'largest_group_count') }} Similar Bursts)
      data:
        tag: leaky_toilet_smart_alert
        priority: high
        channel: Urgent
        actions:
        - action: ACKNOWLEDGE_LEAKY_TOILET_SMART
          title: Acknowledge
    action: notify.all_family
  mode: single
- id: leaky_toilet_smart_acknowledge_alert
  alias: 'Leaky Toilet Smart: Acknowledge Alert'
  trigger:
  - platform: state
    entity_id: input_button.acknowledge_leaky_toilet_smart
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: ACKNOWLEDGE_LEAKY_TOILET_SMART
  action:
  - service: input_boolean.turn_off
    entity_id: input_boolean.leaky_toilet_smart_detected
- id: leaky_toilet_smart_clear
  alias: Leaky Toilet Smart Cleared
  triggers:
  - entity_id:
    - sensor.toilet_water_leak_detected
    to: 'False'
    trigger: state
    from: 'True'
  conditions:
  - condition: state
    entity_id: input_boolean.leaky_toilet_smart_detected
    state: 'on'
  actions:
  - entity_id: input_boolean.leaky_toilet_smart_detected
    action: input_boolean.turn_off
  - data:
      message: "✅ Leaky toilet condition cleared. No more repeated toilet fill patterns
        detected.\n\U0001F4CA **Current Status:** • Similar burst count: {{ state_attr('sensor.toilet_water_leak_detected',
        'largest_group_count') }} • Burst detection: {{ 'Active' if state_attr('sensor.toilet_water_leak_detected',
        'session_active') else 'Inactive' }} • Last burst volume: {{ state_attr('sensor.toilet_water_leak_detected',
        'last_burst_volume') }} gallons"
      title: Leaky Toilet Cleared (Smart)
      data:
        tag: leaky_toilet_smart_alert
        priority: default
        channel: alarm
    action: notify.all_family
  mode: single
- id: log_significant_water_sessions
  alias: Log Significant Water Sessions
  trigger:
  - platform: state
    entity_id: sensor.toilet_water_leak_detected
    attribute: last_burst_volume
  condition:
  - condition: template
    value_template: "{{ \n  trigger.to_state.attributes.last_burst_volume | float(0)
      > \n  trigger.from_state.attributes.last_burst_volume | float(0)\n}}\n"
  - condition: numeric_state
    entity_id: sensor.toilet_water_leak_detected
    attribute: last_burst_volume
    above: 1
  action:
  - service: logbook.log
    data:
      name: Toilet Burst Completed
      message: "\U0001F4A7 Toilet burst: {{ state_attr('sensor.toilet_water_leak_detected',
        'last_burst_volume') }} gallons\n\U0001F4CA Similar bursts: {{ state_attr('sensor.toilet_water_leak_detected',
        'largest_group_count') }}/{{ state_attr('sensor.toilet_water_leak_detected',
        'burst_min_group') }} \U0001F6BD Session status: {{ 'Active' if state_attr('sensor.toilet_water_leak_detected',
        'session_active') else 'Complete' }}"
      entity_id: sensor.toilet_water_leak_detected
  mode: single
- id: large_toilet_session_alert
  alias: Large Toilet Session Alert
  trigger:
  - platform: state
    entity_id: sensor.toilet_water_leak_detected
    attribute: last_burst_volume
  condition:
  - condition: template
    value_template: "{{ \n  trigger.to_state.attributes.last_burst_volume | float(0)
      > \n  trigger.from_state.attributes.last_burst_volume | float(0)\n}}\n"
  - condition: numeric_state
    entity_id: sensor.toilet_water_leak_detected
    attribute: last_burst_volume
    above: 5
  action:
  - service: notify.all_family
    data:
      message: "⚠️ Unusually large toilet session detected: {{ state_attr('sensor.toilet_water_leak_detected',
        'last_burst_volume') }} gallons.\n\U0001F4CA **Session Details:** • Flow range:
        {{ state_attr('sensor.toilet_water_leak_detected', 'burst_min_flow') }}-{{
        state_attr('sensor.toilet_water_leak_detected', 'burst_max_flow') }} GPM •
        Duration: Within {{ state_attr('sensor.toilet_water_leak_detected', 'burst_min_duration')
        }}-{{ state_attr('sensor.toilet_water_leak_detected', 'burst_max_duration')
        }} seconds • Similar bursts: {{ state_attr('sensor.toilet_water_leak_detected',
        'largest_group_count') }}\nThis may indicate a toilet malfunction or stuck
        fill valve."
      title: Large Toilet Session Detected
      data:
        tag: large_toilet_session
        priority: normal
        channel: alarm
  mode: single
- id: toilet_parameters_changed
  alias: Toilet Detection Parameters Changed
  trigger:
  - platform: state
    entity_id: sensor.toilet_water_leak_detected
    attribute: burst_min_flow
  - platform: state
    entity_id: sensor.toilet_water_leak_detected
    attribute: burst_max_flow
  - platform: state
    entity_id: sensor.toilet_water_leak_detected
    attribute: burst_group_threshold
  - platform: state
    entity_id: sensor.toilet_water_leak_detected
    attribute: burst_min_group
  condition:
  - condition: template
    value_template: '{{ trigger.from_state.attributes[trigger.attribute] != trigger.to_state.attributes[trigger.attribute]
      }}

      '
  action:
  - service: logbook.log
    data:
      name: Toilet Detection Parameter Updated
      message: "\U0001F527 Parameter {{ trigger.attribute }} changed from {{ trigger.from_state.attributes[trigger.attribute]
        }}  to {{ trigger.to_state.attributes[trigger.attribute] }}\n\U0001F4CA **Current
        Settings:** • Flow range: {{ state_attr('sensor.toilet_water_leak_detected',
        'burst_min_flow') }}-{{ state_attr('sensor.toilet_water_leak_detected', 'burst_max_flow')
        }} GPM • Group threshold: {{ state_attr('sensor.toilet_water_leak_detected',
        'burst_group_threshold') }} gallons • Min group size: {{ state_attr('sensor.toilet_water_leak_detected',
        'burst_min_group') }}"
      entity_id: sensor.toilet_water_leak_detected
  mode: single
